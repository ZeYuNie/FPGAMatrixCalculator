# FPGA 矩阵计算器功能使用说明文档

## 1. 系统概述

本系统是一个基于 Xilinx Artix-7 FPGA (EGO1 开发板) 的高性能矩阵计算器。系统支持矩阵的串口输入、随机生成、存储管理、全量显示以及多种核心数学运算（加法、乘法、转置、标量乘法）。用户通过 UART 串口终端与系统进行数据交互，并通过板载拨码开关、按钮、LED 和数码管进行实时控制和状态监控。

## 2. 硬件接口与引脚分配

本系统运行于 EGO1 开发板，核心时钟频率为 50MHz (由 100MHz 分频)。

### 2.1 核心控制接口

| 接口名称 | 硬件组件 | EGO1 引脚 | 说明 |
| :--- | :--- | :--- | :--- |
| **系统时钟** | 晶振 | **P17** | 100MHz 输入 |
| **系统复位** | 按键 S6 | **P15** | **rst_n** (低电平有效)。按下复位系统。 |
| **确认/开始** | 按键 S4 | **U4** | **btn**。用于触发操作或确认输入。 |
| **手动清理** | 按键 S1 | **R17** | **btn_clear**。手动清空输入缓冲区，成功后串口返回 `AC`。 |
| **调试打印** | 按键 S3 | **R2** | **btn_dump**。通过串口打印输入缓冲区前 16 个字的内容（十六进制）。 |
| **UART TX** | 接口 | **T4** | 串口发送端 (接上位机 RX) |
| **UART RX** | 接口 | **N5** | 串口接收端 (接上位机 TX) |

> **注意**: 请勿使用 S5 按键 (PROG)，否则会擦除 FPGA 配置。

### 2.2 拨码开关 (Switches)

系统使用 8 个拨码开关 (`SW[7:0]`) 进行模式控制。

| 信号 | 引脚 | 功能定义 | 描述 |
| :--- | :--- | :--- | :--- |
| **SW[7]** | **P5** | **矩阵输入 (Input)** | 开启后，允许通过串口输入矩阵数据。 |
| **SW[6]** | **P4** | **矩阵生成 (Gen)** | 开启后，允许通过串口指令生成随机矩阵。 |
| **SW[5]** | **P3** | **矩阵显示 (Show)** | 开启后，系统将所有存储的矩阵数据通过串口打印。 |
| **SW[4]** | **P2** | **计算模式 (Calculate)** | 开启后，进入矩阵运算流程。 |
| **SW[3]** | **R2** | **设置模式 (Settings)** | 开启后，允许修改系统全局参数。 |
| **SW[2]** | **M4** | **运算选择 Bit 2** | 配合 SW[1:0] 选择具体运算类型。 |
| **SW[1]** | **N4** | **运算选择 Bit 1** | - |
| **SW[0]** | **R1** | **运算选择 Bit 0** | - |

> **模式优先级**: Settings (SW3) > Calculate (SW4) > Show (SW5) > Gen (SW6) > Input (SW7)。建议每次仅开启一个模式开关。

### 2.3 标量输入拨码开关 (Scalar Input Switches)

在标量乘法模式下，使用以下 8 个拨码开关输入标量值 (二进制格式)：

| 信号 | 引脚 | 说明 |
| :--- | :--- | :--- |
| **SW_DIP[7]** | **U3** | MSB (最高位) |
| **SW_DIP[6]** | **U2** | |
| **SW_DIP[5]** | **V2** | |
| **SW_DIP[4]** | **V5** | |
| **SW_DIP[3]** | **V4** | |
| **SW_DIP[2]** | **R3** | |
| **SW_DIP[1]** | **T3** | |
| **SW_DIP[0]** | **T5** | LSB (最低位) |

### 2.4 LED 状态指示

| 信号 | 引脚 | 名称 | 状态描述 |
| :--- | :--- | :--- | :--- |
| **LED[0]** | **K2** | **Error** | 亮起表示操作出错（如维度不匹配、ID 无效）。在输入/生成模式下，Error 灯会闪烁并自动清除，允许立即重试；在其他模式下可能需要复位。 |
| **LED[1]** | **J2** | **Done** | 亮起表示当前操作成功完成。亮起约 0.5 秒后自动熄灭，表示系统已准备好进行下一次操作。 |
| **LED[2]** | **J3** | **Busy** | 亮起表示系统正在处理数据或计算中，请勿进行其他操作。 |
| **LED[7:3]** | **F6-H4** | **Debug** | 显示当前内部识别的模式代码，用于调试。 |
| **LED[11:8]** | **K3-L1** | **State** | (新增) 显示计算模式下的内部状态机状态。 |
| **LED[15:12]** | **K1-J5** | **Count** | (新增) 显示计算模式下已接收的数字个数。 |

### 2.5 数码管显示

数码管用于显示运算类型或性能计数。

*   **引脚**: 段选 `seg[7:0]` (D5...B4), 位选 `an[3:0]` (H1...G2)。
*   **显示内容**:
    *   **待机/设置/输入**: 熄灭。
    *   **计算模式 (准备)**: 显示运算代码 (`A`:加法, `b`:矩阵乘法, `B`:标量乘法, `C`:矩阵乘法, `T`:转置, `J`:卷积)。
        *   `T`: 矩阵转置 (Transpose)
        *   `A`: 矩阵加法 (Add)
        *   `B`: 标量乘法 (Scalar, B for Biaoliang)
        *   `C`: 矩阵乘法 (Cross)
        *   `J`: 卷积 (Juanji)
    *   **计算模式 (完成)**: 显示运算耗时的时钟周期数 (Cycle Count)。

### 2.6 调试与维护功能

#### 2.6.1 手动缓冲区清理 (S1)
在任何模式下，如果您怀疑输入缓冲区存在残留数据（例如上一次输入未完全覆盖），可以按下 **S1 (R17)** 键。
*   **动作**: 系统将启动 BRAM 逐地址清零流程。
*   **反馈**: 清理完成后，串口终端将收到 `AC` (All Clear) 字符串。

#### 2.6.2 缓冲区内容打印 (S3)
为了验证缓冲区是否已清空或检查当前输入的数据，可以按下 **S3 (R2)** 键。
*   **动作**: 系统将读取输入缓冲区的前 16 个 32 位字，并以十六进制格式通过串口发送。
*   **示例输出**: `00000001 00000002 00000003 ...` (如果缓冲区已清空，应显示全 0)。

### 2.7 高级功能与错误处理

#### 2.7.1 随机选择
在选择矩阵 ID（`SELECT_A` 或 `SELECT_B`）阶段，您可以通过 UART 发送 `-1`（即发送字符串 `-1` 并回车），系统将自动从当前有效的矩阵列表中随机选择一个。

#### 2.7.2 合法性检查与倒计时
系统会在计算开始前检查操作数的合法性：
*   **矩阵加法**：要求两个矩阵的维度完全一致。
*   **矩阵乘法**：要求矩阵 A 的列数等于矩阵 B 的行数。

如果检查失败（例如尝试将 4x4 矩阵与 3x3 矩阵相加）：
1.  **Error LED** (LED0) 将亮起。
2.  数码管将显示 **倒计时**（默认 10 秒，从 `10` 倒数至 `0`）。
3.  您必须在倒计时结束前按下 **S4** 键以重试选择。
4.  如果倒计时结束仍未操作，系统将自动复位到初始状态。

---

## 3. 详细操作指南

### 3.1 准备工作
1.  连接 USB-TTL 模块：FPGA **T4** 接模块 RX，FPGA **N5** 接模块 TX，共地。
2.  打开串口调试助手：波特率 **115200**，8数据位，1停止位，无校验。
3.  下载比特流文件，按下 **S6 (P15)** 复位系统。

### 3.2 设置模式 (Settings Mode)
配置系统全局参数（如最大行列数、超时时间）。

1.  **进入模式**:
    *   将拨码开关 `SW[3]` 拨至 **ON** (其他保持 OFF)。
    *   此时 LED G3 和 H4 应亮起，表示已进入设置模式。

2.  **发送指令**:
    *   通过串口调试助手发送指令，格式为 `CMD DATA` (空格分隔，**必须以换行符结尾**)。
    *   **指令列表**:
        *   `1 Val\n`: 设置最大行数 (MaxRow, 1-32)。例如: `1 8\n`
        *   `2 Val\n`: 设置最大列数 (MaxCol, 1-32)。例如: `2 8\n`
        *   `3 Val\n`: 设置数据最小值。例如: `3 0\n`
        *   `4 Val\n`: 设置数据最大值。例如: `4 255\n`
        *   `5 Val\n`: 设置倒计时 (秒, 5-15)。例如: `5 10\n`

3.  **执行确认**:
    *   按下开发板上的 **S4 (Confirm)** 按钮。
    *   **成功反馈**: 观察 **LED[1] (Done)** (引脚 J2)。如果设置成功，该 LED 将亮起约 **0.5 秒**。

4.  **连续设置**:
    *   系统支持连续设置。在 Done 灯熄灭后，您可以直接发送下一条指令并再次按下 S4 确认，无需切换开关或复位。
    *   *示例流程*: 发送 `1 8\n` -> 按 S4 (Done亮) -> 发送 `2 8\n` -> 按 S4 (Done亮)。

### 3.3 矩阵输入模式 (Matrix Input Mode)
手动输入矩阵数据。
1.  **设置开关**: `SW[7]` ON。
2.  **发送数据**:
    *   **自动 ID**: `Rows Cols Data...` (如 `2 2 1 2 3 4`)。
    *   **指定 ID**: `-1 ID Name1 Name2 Rows Cols Data...` (如 `-1 1 0 0 2 2 5 6 7 8`)。
3.  **执行**: 按下 **S4 (Confirm)**。等待 LED[1] (Done) 亮起。
4.  **连续输入**: Done 灯熄灭后，您可以直接发送下一个矩阵的数据并再次按下 S4，无需复位或切换模式。
5.  **错误处理**: 如果 LED[0] (Error) 闪烁，说明输入数据有误（如维度超限）。此时输入缓冲区已自动清空，请检查数据后重新发送并按 S4 提交。

### 3.4 矩阵生成模式 (Matrix Gen Mode)
快速生成随机矩阵。
1.  **设置开关**: `SW[6]` ON。
2.  **发送参数**: `Rows Cols Count` (如 `4 4 1` 生成一个 4x4 矩阵)。
3.  **执行**: 按下 **S4 (Confirm)**。系统自动生成并存储，完成后 LED[1] (Done) 亮起。
4.  **连续生成**: Done 灯熄灭后，您可以直接发送新的生成参数并再次按下 S4。
5.  **错误处理**: 如果 LED[0] (Error) 闪烁，说明参数有误（如请求数量过多）。此时缓冲区已清空，请重新发送正确参数并提交。

### 3.5 矩阵显示模式 (Show Mode)
查看所有已存储的矩阵。
1.  **设置开关**: `SW[5]` ON。
2.  **执行**: 按下 **S4 (Confirm)**。
3.  **结果**: 串口终端将依次打印所有有效矩阵的内容。

### 3.6 计算模式 (Calculate Mode)
执行矩阵运算。
1.  **设置开关**: `SW[4]` ON。
2.  **选择运算 (SW[2:0])**:
    *   `000`: **转置 (T)** - 将矩阵行列互换。
    *   `001`: **加法 (A)** - 两个同维度矩阵相加。
    *   `010`: **矩阵乘法 (C)** - 两个矩阵相乘（要求 A 的列数 = B 的行数）。
    *   `011`: **标量乘法 (B)** - 矩阵与一个常数相乘。
    *   `100`: **卷积 (J)** - 3x3 卷积核对固定图像进行卷积。
3.  **启动**: 按下 **S4 (Confirm)**。
    *   此时 LED[2] (Busy) 亮起，表示进入选择流程。
    *   **系统信息显示**: 系统会首先在 UART 串口终端显示当前存储的所有矩阵信息汇总。
        *   **格式**: `总数 规格1*个数1 规格2*个数2 ...`
        *   **示例**: `3 2*2*1 4*5*2` (表示共有 3 个矩阵，其中 1 个 2x2，2 个 4x5)。
4.  **各运算详细操作流程**:

#### A. 矩阵转置 (Transpose, 'T')
1.  **输入维度**: 发送源矩阵的维度 `Rows Cols` (如 `3 3`) -> 按 **S4**。
2.  **选择矩阵**: 发送源矩阵 ID (如 `1`) -> 按 **S4**。
3.  **完成**: 系统执行转置，结果存入 ID 0。

#### B. 矩阵加法 (Add, 'A')
1.  **输入维度**: 发送两个矩阵共同的维度 `Rows Cols` (如 `3 3`) -> 按 **S4**。
2.  **选择矩阵 A**: 发送第一个矩阵 ID -> 按 **S4**。
3.  **选择矩阵 B**: 发送第二个矩阵 ID -> 按 **S4**。
4.  **完成**: 系统执行加法，结果存入 ID 0。

#### C. 矩阵乘法 (Cross, 'C')
1.  **输入维度**: 发送维度 `Rows Cols` (如 `3 3`) -> 按 **S4**。
    *   *注意*: 当前设计中，系统会筛选出所有符合该维度的矩阵。为了满足乘法条件 (A 的列 = B 的行)，建议输入方阵维度。
2.  **选择矩阵 A**: 发送第一个矩阵 ID -> 按 **S4**。
3.  **选择矩阵 B**: 发送第二个矩阵 ID -> 按 **S4**。
4.  **完成**: 系统执行乘法，结果存入 ID 0。

#### D. 标量乘法 (Scalar, 'B')
1.  **输入维度**: 发送源矩阵的维度 `Rows Cols` (如 `3 3`) -> 按 **S4**。
2.  **选择矩阵**: 发送源矩阵 ID -> 按 **S4**。
3.  **输入标量**: 通过 **标量输入拨码开关 (SW_DIP[7:0])** 设置标量值 (二进制) -> 按 **S4**。
4.  **完成**: 系统执行标量乘法，结果存入 ID 0。

#### E. 卷积 (Juanji, 'J')
1.  **输入维度**: **必须**发送 `3 3` -> 按 **S4**。
    *   *说明*: 卷积操作使用 3x3 的卷积核。
2.  **选择卷积核**: 发送作为卷积核的 3x3 矩阵 ID -> 按 **S4**。
3.  **完成**: 系统对内置的 10x12 图像进行卷积，结果 (8x10) 存入 ID 0。

5.  **结果反馈**:
    *   **LED[1] (Done)** 亮起表示成功。
    *   **数码管** 显示计算耗时的时钟周期数。
    *   **Error LED** 亮起表示维度不匹配或 ID 无效，此时会进入倒计时重试流程。

---

## 4. 完整操作示例 (Complete Operation Examples)

为了帮助您快速上手，本节提供了从系统配置到矩阵运算的完整操作流程示例。

### 4.1 示例 1：系统初始化与参数配置
**目标**：设置系统允许的最大矩阵维度为 8x8，并将错误重试倒计时设置为 15 秒。
1.  **拨码开关**：将 `SW[3]` (Settings) 拨至 **ON**，其余拨至 **OFF**。
2.  **设置最大行数**：
    *   在串口助手输入：`1 8` 并回车。
    *   按下开发板 **S4** 键。观察 **LED[1]** (Done) 亮起。
3.  **设置最大列数**：
    *   在串口助手输入：`2 8` 并回车。
    *   按下开发板 **S4** 键。观察 **LED[1]** (Done) 亮起。
4.  **设置倒计时**：
    *   在串口助手输入：`5 15` 并回车。
    *   按下开发板 **S4** 键。观察 **LED[1]** (Done) 亮起。
5.  **退出设置**：将 `SW[3]` 拨回 **OFF**。

### 4.2 示例 2：手动输入矩阵
**目标**：向系统存入一个 2x3 矩阵。
1.  **拨码开关**：将 `SW[7]` (Input) 拨至 **ON**。
2.  **发送数据**：
    *   在串口助手输入：`-1 1 0 0 2 3 10 20 30 40 50 60` 并回车。
    *   *解析*：`-1` (指定ID模式), `1` (ID=1), `0 0` (不具名), `2 3` (2行3列), `10...60` (元素数据)。
3.  **执行**：按下开发板 **S4** 键。
4.  **验证**：**LED[1]** (Done) 亮起表示存储成功。

### 4.3 示例 3：执行矩阵加法
**目标**：将 ID 1 和 ID 2 的两个 2x2 矩阵相加。
1.  **拨码开关**：将 `SW[4]` (Calculate) 拨至 **ON**，将 `SW[2:0]` 拨至 `001` (Add)。
2.  **启动计算**：按下开发板 **S4** 键。
3.  **输入维度**：
    *   串口提示后，输入：`2 2` 并回车。
    *   按下 **S4** 键。
4.  **选择操作数**：
    *   提示选择 A 时，输入：`1` 并回车 -> 按下 **S4**。
    *   提示选择 B 时，输入：`2` 并回车 -> 按下 **S4**。
5.  **查看结果**：
    *   计算完成后，**LED[1]** (Done) 亮起。
    *   数码管显示本次加法消耗的时钟周期数。
    *   切换至 **Show 模式** (`SW[5]` ON -> 按 S4) 即可在串口看到 ID 0 处存储的加法结果。

### 4.4 示例 4：执行卷积运算 (Winograd 加速)
**目标**：使用 ID 3 处的 3x3 矩阵作为卷积核，对系统内置图像进行卷积。
1.  **拨码开关**：将 `SW[4]` (Calculate) 拨至 **ON**，将 `SW[2:0]` 拨至 `100` (Conv)。
2.  **启动计算**：按下开发板 **S4** 键。
3.  **输入维度**：
    *   输入：`3 3` 并回车 -> 按下 **S4**。
4.  **选择卷积核**：
    *   输入：`3` 并回车 -> 按下 **S4**。
5.  **性能评估**：
    *   计算完成后，数码管将显示一个较大的数值（如 `884`），这代表了 Winograd 算法处理 10x12 图像所消耗的总时钟周期。
