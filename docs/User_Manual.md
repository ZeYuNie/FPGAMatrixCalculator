# FPGA 矩阵计算器功能使用说明文档

## 1. 系统概述

本系统是一个基于 Xilinx Artix-7 FPGA (EGO1 开发板) 的高性能矩阵计算器。系统支持矩阵的串口输入、随机生成、存储管理、全量显示以及多种核心数学运算（加法、乘法、转置、标量乘法）。用户通过 UART 串口终端与系统进行数据交互，并通过板载拨码开关、按钮、LED 和数码管进行实时控制和状态监控。

## 2. 硬件接口与引脚分配

本系统运行于 EGO1 开发板，核心时钟频率为 50MHz (由 100MHz 分频)。

### 2.1 核心控制接口

| 接口名称 | 硬件组件 | EGO1 引脚 | 说明 |
| :--- | :--- | :--- | :--- |
| **系统时钟** | 晶振 | **P17** | 100MHz 输入 |
| **系统复位** | 按键 S6 | **P15** | **rst_n** (低电平有效)。按下复位系统。 |
| **确认/开始** | 按键 S4 | **U4** | **btn**。用于触发操作或确认输入。 |
| **UART TX** | 接口 | **T4** | 串口发送端 (接上位机 RX) |
| **UART RX** | 接口 | **N5** | 串口接收端 (接上位机 TX) |

> **注意**: 请勿使用 S5 按键 (PROG)，否则会擦除 FPGA 配置。

### 2.2 拨码开关 (Switches)

系统使用 8 个拨码开关 (`SW[7:0]`) 进行模式控制。

| 信号 | 引脚 | 功能定义 | 描述 |
| :--- | :--- | :--- | :--- |
| **SW[7]** | **P5** | **矩阵输入 (Input)** | 开启后，允许通过串口输入矩阵数据。 |
| **SW[6]** | **P4** | **矩阵生成 (Gen)** | 开启后，允许通过串口指令生成随机矩阵。 |
| **SW[5]** | **P3** | **矩阵显示 (Show)** | 开启后，系统将所有存储的矩阵数据通过串口打印。 |
| **SW[4]** | **P2** | **计算模式 (Calculate)** | 开启后，进入矩阵运算流程。 |
| **SW[3]** | **R2** | **设置模式 (Settings)** | 开启后，允许修改系统全局参数。 |
| **SW[2]** | **M4** | **运算选择 Bit 2** | 配合 SW[1:0] 选择具体运算类型。 |
| **SW[1]** | **N4** | **运算选择 Bit 1** | - |
| **SW[0]** | **R1** | **运算选择 Bit 0** | - |

> **模式优先级**: Settings (SW3) > Calculate (SW4) > Show (SW5) > Gen (SW6) > Input (SW7)。建议每次仅开启一个模式开关。

### 2.3 LED 状态指示

| 信号 | 引脚 | 名称 | 状态描述 |
| :--- | :--- | :--- | :--- |
| **LED[0]** | **K2** | **Error** | 亮起表示操作出错（如维度不匹配、ID 无效）。需复位或切换模式清除。 |
| **LED[1]** | **J2** | **Done** | 亮起表示当前操作成功完成。 |
| **LED[2]** | **J3** | **Busy** | 亮起表示系统正在处理数据或计算中，请勿进行其他操作。 |
| **LED[7:3]** | **F6-H4** | **Debug** | 显示当前内部识别的模式代码，用于调试。 |

### 2.4 数码管显示

数码管用于显示运算类型或性能计数。

*   **引脚**: 段选 `seg[7:0]` (D5...B4), 位选 `an[3:0]` (H1...G2)。
*   **显示内容**:
    *   **待机/设置/输入**: 熄灭。
    *   **计算模式 (准备)**: 显示运算代码 (`A`:加法, `b`:乘法, `C`:标量乘, `T`:转置)。
    *   **计算模式 (完成)**: 显示运算耗时的时钟周期数 (Cycle Count)。

---

## 3. 详细操作指南

### 3.1 准备工作
1.  连接 USB-TTL 模块：FPGA **T4** 接模块 RX，FPGA **N5** 接模块 TX，共地。
2.  打开串口调试助手：波特率 **115200**，8数据位，1停止位，无校验。
3.  下载比特流文件，按下 **S6 (P15)** 复位系统。

### 3.2 设置模式 (Settings Mode)
配置系统全局参数（如最大行列数、超时时间）。

1.  **进入模式**:
    *   将拨码开关 `SW[3]` 拨至 **ON** (其他保持 OFF)。
    *   此时 LED G3 和 H4 应亮起，表示已进入设置模式。

2.  **发送指令**:
    *   通过串口调试助手发送指令，格式为 `CMD DATA` (空格分隔，**必须以换行符结尾**)。
    *   **指令列表**:
        *   `1 Val\n`: 设置最大行数 (MaxRow, 1-32)。例如: `1 8\n`
        *   `2 Val\n`: 设置最大列数 (MaxCol, 1-32)。例如: `2 8\n`
        *   `3 Val\n`: 设置数据最小值。例如: `3 0\n`
        *   `4 Val\n`: 设置数据最大值。例如: `4 255\n`
        *   `5 Val\n`: 设置倒计时 (秒, 5-15)。例如: `5 10\n`

3.  **执行确认**:
    *   按下开发板上的 **S4 (Confirm)** 按钮。
    *   **成功反馈**: 观察 **LED[1] (Done)** (引脚 J2)。如果设置成功，该 LED 将亮起约 **0.5 秒**。

4.  **连续设置**:
    *   系统支持连续设置。在 Done 灯熄灭后，您可以直接发送下一条指令并再次按下 S4 确认，无需切换开关或复位。
    *   *示例流程*: 发送 `1 8\n` -> 按 S4 (Done亮) -> 发送 `2 8\n` -> 按 S4 (Done亮)。

### 3.3 矩阵输入模式 (Matrix Input Mode)
手动输入矩阵数据。
1.  **设置开关**: `SW[7]` ON。
2.  **发送数据**:
    *   **自动 ID**: `Rows Cols Data...` (如 `2 2 1 2 3 4`)。
    *   **指定 ID**: `-1 ID Name1 Name2 Rows Cols Data...` (如 `-1 1 0 0 2 2 5 6 7 8`)。
3.  **执行**: 按下 **S4 (Confirm)**。等待 LED[1] (Done) 亮起。

### 3.4 矩阵生成模式 (Matrix Gen Mode)
快速生成随机矩阵。
1.  **设置开关**: `SW[6]` ON。
2.  **发送参数**: `Rows Cols Count` (如 `4 4 1` 生成一个 4x4 矩阵)。
3.  **执行**: 按下 **S4 (Confirm)**。系统自动生成并存储，完成后 LED[1] (Done) 亮起。

### 3.5 矩阵显示模式 (Show Mode)
查看所有已存储的矩阵。
1.  **设置开关**: `SW[5]` ON。
2.  **执行**: 按下 **S4 (Confirm)**。
3.  **结果**: 串口终端将依次打印所有有效矩阵的内容。

### 3.6 计算模式 (Calculate Mode)
执行矩阵运算。
1.  **设置开关**: `SW[4]` ON。
2.  **选择运算 (SW[2:0])**:
    *   `000`: **转置 (T)**
    *   `001`: **加法 (A)**
    *   `010`: **乘法 (b)**
    *   `011`: **标量乘 (C)**
3.  **启动**: 按下 **S4 (Confirm)**。
4.  **交互流程** (根据串口提示操作):
    *   **输入维度**: 发送 `Rows Cols` (如 `3 3`) -> 按 **S4**。
    *   **选择矩阵 A**: 发送 `ID` (如 `0`) -> 按 **S4**。
    *   **选择矩阵 B** (若需要): 发送 `ID` (如 `1`) -> 按 **S4**。
    *   **输入标量** (若需要): 发送数值 -> 按 **S4**。
5.  **结果**:
    *   LED[1] (Done) 亮起。
    *   数码管显示计算耗时。
    *   结果矩阵自动存储到新的 ID。

## 4. 故障排除
*   **LED[0] (Error) 常亮**: 检查输入维度是否超限，或矩阵 ID 是否存在。按 S6 复位。
*   **串口无数据**: 检查波特率 (115200) 及接线 (TX/RX 是否接反)。
*   **数码管不亮**: 确认是否处于计算模式，其他模式默认关闭。
