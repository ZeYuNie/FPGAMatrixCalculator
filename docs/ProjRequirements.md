# SUSTECH-CS207-PROJECT: 基于FPGA的矩阵计算器

## 一、项目概述

本项目旨在设计并实现一个基于FPGA的矩阵计算器电路。该电路需支持矩阵的生成、展示、运算等功能，并通过开发板上的基础输入输出设备及UART串口与用户进行数据交互。

- **核心目标**: 实现一个功能完备的矩阵计算器。
- **矩阵规格**: 默认维度上限为 5x5，矩阵元素值为 0-9 之间的整数。
- **交互方式**:
  - **输入**: 开发板拨码开关、按键、UART串口通信软件。
  - **输出**: 开发板LED灯、7段数码管、UART串口通信软件。

## 二、核心功能

系统开机后进入主菜单，用户可选择以下功能：

1. **矩阵输入及存储**
2. **矩阵生成及存储**
3. **矩阵展示**
4. **矩阵运算**

每个功能模式结束后，用户可选择继续停留在当前模式或返回主菜单。在“矩阵运算”模式下，可选择具体运算类型，结束后可继续同类运算、切换运算类型或返回主菜单。

### 2.1 输入输出处理

#### 2.1.1 输入

1. **功能选择**: 使用开发板的拨码开关设置工作模式，使用按键作为“确认键”。
2. **数据输入**: 通过UART传输软件输入矩阵维度、元素等信息，点击“发送”按钮将数据送入系统。
    > **说明**: 如UART功能未实现，使用键盘实现相同方式的输入则视为等价，不扣分。

#### 2.1.2 输出

1. **板载状态显示**:
    - **LED灯**: 用于输入合法性检测。输入有误时点亮，无误则熄灭。
    - **7段数码管**: 用于显示倒计时等信息。
2. **数据显示**: 运算的操作数、运算结果等通过UART输出到传输软件的接收窗口进行展示。
    > **说明**: 如UART功能未实现，使用VGA实现相同格式的输出则视为等价，不扣分。

### 2.2 矩阵输入、生成及存储

- **存储容量**: 系统支持每种规格 (m x n) 的矩阵最多存储 `x` 个（`x`可配置，默认为2）。
- **维度范围**: 矩阵维度 m 和 n 的值可配置，默认为 1~5 之间的整数。

#### 2.2.1 用户输入矩阵并存储

1. **输入流程**: 用户先输入矩阵维度 `m` 和 `n`，然后按“先行后列”的顺序输入所有矩阵元素。
    - **示例**: 输入一个 2x3 矩阵 `[[4,5,6],[7,8,9]]`。

    | 发送窗口的输入数据              | 生成的矩阵                 |
    | :------------------------------ | :------------------------- |
    | `2` `3` `4` `5` `6` `7` `8` `9` | `[ [4, 5, 6], [7, 8, 9] ]` |

2. **系统检测**:
    - **维度范围**: 若维度超出 1~5，点亮报错LED，要求用户重新输入。
    - **元素范围**: 若元素值超出 0~9，点亮报错LED，要求用户重新输入。
    - **元素个数**:
        - **不足**: 若输入元素数量少于 `m*n`，不足部分自动补0。
        - **超出**: 若输入元素数量多于 `m*n`，只取前 `m*n` 个，多余的忽略。

#### 2.2.2 系统生成随机矩阵并存储

1. **输入流程**: 用户输入矩阵维度 `m` 和 `n`，以及需要生成的矩阵个数（不超过2个）。
2. **生成逻辑**: 电路根据输入生成相应数量和维度的矩阵，矩阵元素为随机数。
    > **注意**: 使用递增或递减方式产生的数字不是随机数，不得分。
    - **示例**: 用户输入 `1 3 2`，表示需要2个 1x3 的矩阵。系统随机生成 `8 2 6 5 7 9`。

| 用户输入 | 矩阵A       | 矩阵B       |
| :------- | :---------- | :---------- |
| `1 3 2`  | `[8, 2, 6]` | `[5, 7, 9]` |

#### 2.2.3 系统存储矩阵

- 系统自动为存储的矩阵（用户输入或系统生成）进行编号。
- 每种规格的矩阵最多存储 `x` 个。当存储满后，新输入的同规格矩阵将按顺序覆盖旧矩阵（例如，新矩阵C覆盖A，下一个新矩阵D覆盖B）。

### 2.3 矩阵展示

- 需以清晰的方式在UART接收窗口展示矩阵，元素间以空格隔开，行与行之间换行。
- 一次展示多个矩阵时，从上到下依次展示。
- **示例**: 输出 2x3 矩阵 `[[4,5,6],[7,8,9]]`。

  ```text
  4 5 6
  7 8 9
  ```

### 2.4 矩阵运算

支持的运算类型包括：**矩阵转置、矩阵加法、标量乘法、矩阵乘法**（均为必选），以及**卷积**（附加功能）。

#### 2.4.1 选择运算类型

1. **选择方式**: 使用拨码开关选择运算类型，按“确认键”确认。
2. **状态显示**: 7段数码管显示当前选中的运算类型代号。
    - `T`: 矩阵转置 (Transpose)
    - `A`: 矩阵加法 (Add)
    - `B`: 标量乘法 (Scalar, B for Biaoliang)
    - `C`: 矩阵乘法 (Cross)
    - `J`: 卷积 (Juanji)

#### 2.4.2 显示存储矩阵信息

- 选择运算类型后，系统在UART接收窗口显示当前存储的所有矩阵信息，格式为 `总数 规格1*个数1 规格2*个数2 ...`。
- **示例**: 系统存储了1个 2x2 矩阵和2个 4x5 矩阵。

  ```text
  3 2*2*1 4*5*2
  ```

#### 2.4.3 选择运算数

##### 用户选择

a. **指定维度**: 用户输入所需操作数的维度 `m` 和 `n`。
b. **展示矩阵**: 系统在UART接收窗口显示该维度下的所有矩阵及其编号。
c. **选择矩阵**: 用户输入矩阵编号，按“确认键”选定。
d. **显示选定矩阵**: 系统在UART接收窗口显示用户选定的操作数。
e. **选择模式**:
    - **单矩阵运算 (转置等)**: 执行一次 a-d 流程。
    - **双矩阵运算 (加法、乘法)**: 重复两次 a-d 流程。
    - **矩阵与标量运算**: 执行一次 a-d 流程选择矩阵，然后通过拨码开关输入标量值，按“确认键”确认。

##### 合法性判定

- **判定规则**:
  - **矩阵加法**: 两个矩阵维度必须相同。
  - **矩阵乘法**: A(m x n) * B(p x q) 要求 `n == p`。
- **判定结果**:
  - **合法**: 进入计算模式。
  - **不合法**:
    1. 点亮报错LED。
    2. 在数码管上显示倒计时（默认为10秒，可动态配置为5~15秒）。
    3. 用户需在倒计时内重新完成所有操作数的选择。
    4. 若超时未完成，则本次输入无效，返回操作数选择的初始阶段。

##### 系统自动选择

- 系统可根据运算要求，从已存储的矩阵中自动随机选择符合要求的操作数。
- 若为标量乘法，标量 `x` 在 0~9 之间随机选取。
- 选择完毕后，将操作数依次显示在输出设备上。

#### 2.4.4 矩阵计算与结果展示

##### 1. 矩阵转置

- **示例**: 对矩阵 `A(1x3) = [1, 2, 3]` 进行转置，结果显示如下：

  ```text
  1
  2
  3
  ```

##### 2. 矩阵加法

- **示例**: `A(2x3) + B(2x3)`，结果 `C(2x3)` 显示如下：

  ```text
  4 5 6
  5 6 7
  ```

##### 3. 标量乘法

- **示例**: `A(2x3) * 3`，结果 `C(2x3)` 显示如下：

  ```text
  3 6 9
  9 12 15
  ```

##### 4. 矩阵乘法

- **示例**: `A(2x3) * B(3x2)`，结果 `C(2x2)` 显示如下：

  ```text
  14 8
  26 14
  ```

---

## 三、附加功能 (Bonus)

### 3.1 输出矩阵时按列元素靠左对齐展示

- **示例**:

  ```text
  1   123
  25  1920 45
  -5  8
  26  -4
  ```

### 3.2 动态配置功能

系统参数支持在运行过程中由用户输入指定并立即生效，无需重新生成bit文件。

- **可配置参数**:
  1. 每种规格矩阵的最大存储个数 `x` (默认为2)。
  2. 矩阵元素的数值范围 (默认为 `[0, 9]`)。

### 3.3 卷积功能

实现步长 (stride) 为 1 的卷积运算。

- **输入**:
  - **Input Image**: 一个固定的 10x12 矩阵，通过 `hardcode` 方式在Verilog中实现。
  - **Kernel**: 一个 3x3 的矩阵，由用户现场输入。
- **计算**: 输入卷积核后，立即开始计算并统计所用的时钟周期数。
- **输出**:
  - **结果矩阵**: 在串口显示 8x10 的输出矩阵。
  - **性能**: 在数码管显示总时钟周期数。

**Input Image (10x12) Hardcode 示例**:

```verilog
module input_image_rom(
    input clk,
    input [3:0] x, // 行地址
    input [3:0] y, // 列地址
    output reg [3:0] data_out // 输出
);
    // ROM存储器定义 - 10行×12列=120个元素
    reg [3:0] rom[0:119];
  
    // 初始化ROM内容
    initial begin
        // 第1行: 372905184632
        rom[0]=4'd3; rom[1]=4'd7; rom[2]=4'd2; rom[3]=4'd9;
        // ... (此处省略所有初始化代码)
        rom[119]=4'd7;
    end

    // 同步读取
    wire [6:0] addr;
    assign addr = x * 12 + y;
  
    always @(posedge clk) begin
        data_out <= rom[addr];
    end
endmodule
```

---

## 四、项目交付要求 (PPT及讲解视频)

需提供一份10页以内图文并茂的PPT，并以录屏方式制作讲解视频。

- **PPT要求**: 简洁明了，禁止大段粘贴文字和代码。
- **讲解视频**: 使用腾讯会议录屏功能制作。

**PPT及讲解必须包含以下内容**:

1. **系统架构框图**: 简易框图，并标出卷积模块的位置和接口。
2. **卷积模块设计图**: 模块内部设计示意图。
3. **数据流控制方案**: 描述数据如何在模块间流动和控制。
4. **性能优化策略** (如有)。
5. **LLM辅助优化效果分析** (如有)。
6. **理论周期数分析**: 对卷积运算的理论耗时进行分析。
7. **实际测试周期数对比**: 对比理论与实际测试结果，并说明实际运行时钟频率。
8. **资源使用报告**: 整个工程以及卷积子模块的资源占用情况。
9. **遇到的问题与解决方案**。

---

## 附录：Vivado 资源使用报告查看方法

1. 在 Vivado 工程中，右键单击要评估的电路模块，选择 **Set as Top**。
2. 在 **IMPLEMENTATION** 流程下，点击 **Run Implementation**。
3. 实现完成后，在 **IMPLEMENTATION** 下选择 **Report Utilization**。
4. 在打开的 **Utilization** 窗口左侧选择 **Summary**，即可查看详细的资源使用报告。
