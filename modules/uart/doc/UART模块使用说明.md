# UART 模块使用说明文档

## 1. 系统概述

该系统实现了一个基本的串口回环或收发测试环境：

- **发送 (TX)**：读取板载 8 位拨码开关/按键 (`key`) 的状态作为数据，通过按键 (`send_one`) 触发，将数据通过 UART TX 发送给上位机。
- **接收 (RX)**：通过 UART RX 接收来自上位机的数据，并将接收到的 8 位数据显示在板载 LED (`led`) 上。

**通信参数：**

- **波特率**：115200
- **数据位**：8
- **停止位**：1
- **校验位**：无
- **流控**：无
- **系统时钟**：100MHz

## 2. 硬件引脚分配

根据 `constraints/top.xdc` 文件，FPGA 引脚分配如下：

### 2.1 系统信号

| 信号名 | 引脚    | 说明                  |
| :----- | :------ | :-------------------- |
| `clk`  | **P17** | 系统时钟输入 (100MHz) |

### 2.2 UART 接口

| 信号名    | 引脚   | 说明        | 连接方式                      |
| :-------- | :----- | :---------- | :---------------------------- |
| `uart_tx` | **T4** | FPGA 发送端 | 连接到 USB-TTL 模块的 **RXD** |
| `uart_rx` | **N5** | FPGA 接收端 | 连接到 USB-TTL 模块的 **TXD** |

### 2.3 控制与指示信号

| 信号名          | 引脚    | 类型     | 说明                                |
| :-------------- | :------ | :------- | :---------------------------------- |
| `uart_tx_rst_n` | **T3**  | 按键输入 | 发送模块复位 (低电平有效)           |
| `uart_rx_rst_n` | **T5**  | 按键输入 | 接收模块复位 (低电平有效)           |
| `send_one`      | **R11** | 按键输入 | **发送触发键** (按下触发一次发送)   |
| `uart_tx_work`  | **M1**  | LED 输出 | 发送模块工作状态指示 (复位释放时亮) |
| `uart_rx_work`  | **K3**  | LED 输出 | 接收模块工作状态指示 (复位释放时亮) |

### 2.4 数据输入 (Key)

用于设置发送给上位机的 8 位数据。

| 信号位   | 引脚 |
| :------- | :--- |
| `key[7]` | P5   |
| `key[6]` | P4   |
| `key[5]` | P3   |
| `key[4]` | P2   |
| `key[3]` | R2   |
| `key[2]` | M4   |
| `key[1]` | N4   |
| `key[0]` | R1   |

### 2.5 数据输出 (LED)

用于显示从上位机接收到的 8 位数据。

| 信号位   | 引脚 |
| :------- | :--- |
| `led[7]` | F6   |
| `led[6]` | G4   |
| `led[5]` | G3   |
| `led[4]` | J4   |
| `led[3]` | H4   |
| `led[2]` | J3   |
| `led[1]` | J2   |
| `led[0]` | K2   |

## 3. 操作指南

### 3.1 准备工作

1. 将 FPGA 开发板通过下载器连接到电脑。
2. 使用 USB-TTL 串口模块连接 FPGA 的 UART 引脚：
    - FPGA **T4 (TX)** <--> 串口模块 **RX**
    - FPGA **N5 (RX)** <--> 串口模块 **TX**
    - GND <--> GND
3. 在电脑上打开串口调试助手（如 PuTTY, TeraTerm, XCOM 等）。
4. 设置串口参数：**波特率 115200，数据位 8，停止位 1，无校验**。
5. 下载比特流文件到 FPGA。

### 3.2 复位检查

- 下载完成后，观察 LED **M1** (`uart_tx_work`) 和 **K3** (`uart_rx_work`)。
- 如果这两个 LED 点亮，说明模块复位已释放，处于工作状态。
- 如果 LED 不亮，尝试按下 **T3** 或 **T5** 按键进行复位操作。

### 3.3 数据发送测试 (FPGA -> PC)

1. 拨动板上的拨码开关/按键 `key[7:0]`，设置你想要发送的数值（例如二进制 `01000001` 对应 ASCII 字符 'A'，十六进制 0x41）。
2. 按下 **R11** (`send_one`) 按键。
3. 观察电脑上的串口调试助手，应该能收到对应的数据（如字符 'A' 或十六进制 41）。
4. **注意**：`send_one` 逻辑设计为检测上升沿触发，即按下按键的瞬间触发一次发送。

### 3.4 数据接收测试 (PC -> FPGA)

1. 在电脑串口调试助手的发送区输入一个字节的数据（例如十六进制 `55` 或 `AA`）。
2. 点击发送。
3. 观察 FPGA 板上的 LED 灯 `led[7:0]`。
4. LED 的亮灭状态应对应发送数据的二进制位（亮代表 1，灭代表 0，具体取决于板载 LED 的极性，通常高电平点亮）。

## 4. 模块代码说明

### 4.1 `top.v`

顶层模块，负责连接各个子模块和 IO 端口。

- 包含按键消抖/边沿检测逻辑 (`send_one_d1`, `send_one_d2`) 用于生成 `send_flag` 信号。
- 将 `uart_rx` 接收到的数据直接映射到 `led` 输出。

### 4.2 `uart_tx.v`

串口发送模块。

- 状态机控制：空闲 -> 发送起始位 -> 发送 8 位数据 -> 发送停止位 -> 结束。
- 使用 `BAUD_DIV` (100MHz / 115200) 控制发送每一位的持续时间。

### 4.3 `uart_rx.v`

串口接收模块。

- 使用双触发器 (`rx_d1`, `rx_d2`) 对输入信号进行同步，防止亚稳态。
- 检测起始位（下降沿）开始接收。
- 在每一位时间的中间时刻采样数据，确保数据准确性。
