# matrix_storage_manager 使用说明

## 功能

统一管理矩阵数据的 BRAM 存储，支持矩阵写入和读取操作。

## 参数

- `BLOCK_SIZE`: 每个矩阵块大小，默认 1152
- `DATA_WIDTH`: 数据位宽，默认 32
- `ADDR_WIDTH`: 地址位宽，默认 14
- `DEPTH`: BRAM 深度，默认 9216

## 接口

### 写入接口

| 信号 | 方向 | 位宽 | 说明 |
|------|------|------|------|
| `write_request` | 输入 | 1 | 写请求，拉高启动写操作 |
| `write_ready` | 输出 | 1 | 写就绪标志 |
| `matrix_id` | 输入 | 3 | 矩阵 ID (0-7) |
| `actual_rows` | 输入 | 8 | 实际行数 |
| `actual_cols` | 输入 | 8 | 实际列数 |
| `matrix_name` | 输入 | 8[0:7] | 矩阵名称，8 字节 |
| `data_in` | 输入 | 32 | 写入数据 |
| `data_valid` | 输入 | 1 | 数据有效标志 |
| `write_done` | 输出 | 1 | 写完成标志 |
| `writer_ready` | 输出 | 1 | 写模块就绪 |

> **握手约定**：`write_ready` 在状态机处于 `IDLE/DONE` 时为高，表示可以接受新的 `write_request`；`writer_ready` 在 `IDLE` 与尚未写满的 `WRITE_DATA` 阶段为高，用于与 `data_valid` 逐拍握手。

### 清除接口

| 信号 | 方向 | 位宽 | 说明 |
|------|------|------|------|
| `clear_request` | 输入 | 1 | 清除请求信号 |
| `clear_done` | 输出 | 1 | 清除完成标志（单周期脉冲） |
| `clear_matrix_id` | 输入 | 3 | 要清除的矩阵 ID (0-7) |

> **清除功能**：清除操作将指定矩阵的元数据（行数、列数、名称）写为全0，标记该槽位为空闲状态。清除操作具有最高优先级，可中断读写操作。

### 读取接口

| 信号 | 方向 | 位宽 | 说明 |
|------|------|------|------|
| `read_addr` | 输入 | 14 | 读地址 |
| `data_out` | 输出 | 32 | 读出数据 |

## 使用流程

### 写入矩阵

1. 等待 `write_ready` 为高，表示状态机空闲或已完成上一笔写入。
2. 设置 `matrix_id`、`actual_rows`、`actual_cols`、`matrix_name` 等元数据信息。
3. 在 `write_ready` 为高时拉高 `write_request` 一周期触发写过程。
4. 元数据写完后 `writer_ready` 会重新拉高，此后在 `writer_ready` 与 `data_valid` 双向握手下持续按行优先送入矩阵数据；当 `writer_ready` 变低或 `write_done` 拉高时停止送数。
5. `write_done` 与 `write_ready` 再次为高时，代表该矩阵写入完成，可开始下一笔写入。

### 清除矩阵

1. 设置 `clear_matrix_id` 为要清除的矩阵 ID
2. 拉高 `clear_request` 一个周期
3. 等待 `clear_done` 脉冲，表示清除完成
4. 清除操作将元数据写为 0，释放该槽位

> **注意**：清除操作优先级高于写入和读取，可以随时发起。

### 读取数据

1. 提供 `read_addr`（绝对地址）
2. 下一周期 `data_out` 输出对应数据

## 地址分配

- 每个矩阵占用 BLOCK_SIZE (1152) 个地址空间
- 矩阵 ID 0-7 分别对应地址段：
  - ID 0: 0x0000 - 0x047F
  - ID 1: 0x0480 - 0x08FF
  - ...
  - ID 7: 0x1C80 - 0x20FF

## 存储格式

每个矩阵块前 3 个地址存储元数据：

- 地址 0: {rows[7:0], cols[7:0], 16'b0}
- 地址 1: matrix_name[0:3]
- 地址 2: matrix_name[4:7]
- 地址 3+: 矩阵数据（行优先）

## 内部模块

### matrix_writer

负责处理矩阵写入操作，包括元数据和数据的写入。详见 `matrix_writer.sv`。

### matrix_clearer

负责清除矩阵元数据，将指定矩阵的前 3 个地址写为全 0。详见 [`matrix_clearer.md`](matrix_clearer.md)。

### BRAM 仲裁逻辑

模块内部对 BRAM 访问进行仲裁：
- **优先级**：清除 > 写入 > 读取
- **清除操作**：最高优先级，可立即执行
- **写入操作**：`writer` 活跃时独占 BRAM
- **读取操作**：默认操作，非写入/清除时进行

## 其它事项

1. 清除操作具有最高优先级，可中断写入和读取
2. 写操作期间无法读取，读操作自动在非写/清除状态进行
3. 读延迟 1 周期
4. 矩阵数据必须按行优先顺序连续写入
5. 非写/清除周期 `bram_wr_en` 保持 0，可防止伪写入
6. 清除操作仅清除元数据（3 个地址），不清除实际矩阵数据

## 相关文档

- [`matrix_clearer.md`](matrix_clearer.md) - 矩阵清除模块详细说明
