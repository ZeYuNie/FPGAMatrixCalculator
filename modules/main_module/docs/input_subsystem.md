# Input Subsystem (输入子系统) 设计文档

## 1. 概述

`input_subsystem` 是 FPGA 矩阵计算器项目的核心输入控制模块。它负责接收来自 UART 的 ASCII 数据流，将其解析为整数，并根据当前的操作模式（矩阵输入、随机生成、系统设置）将数据分发给相应的处理单元。该模块集成了全局输入缓冲区、多个专用处理器以及与后端存储管理器的接口。

## 2. 架构与模块

该子系统由以下核心组件构成：

1.  **`ascii_num_sep_top` (全局输入缓冲区)**:
    *   **功能**: 实时接收 UART 字节流，识别并解析 ASCII 格式的整数（支持负数），存储在内部双端口 RAM 中。
    *   **特性**: 自动处理空格分隔符，支持 `\n` 或 `\r` 作为包结束符。
    *   **清除机制**: 当系统模式发生切换时，缓冲区会自动清除，防止数据污染。

2.  **`settings_data_handler` (设置处理器)**:
    *   **功能**: 解析设置指令，更新系统全局参数（如最大行列数、数据范围等）。
    *   **协议**: 每次启动仅处理**一对**指令（命令字 + 数据字）。

3.  **`matrix_input_handler` (矩阵输入处理器)**:
    *   **功能**: 从缓冲区读取矩阵数据，支持“匿名矩阵”和“命名矩阵”两种格式，并将数据写入 `matrix_storage_manager`。
    *   **特性**: 具备维度检查、数值范围检查及自动补零功能。

4.  **`matrix_rand_gen_handler` (随机生成处理器)**:
    *   **功能**: 根据输入的参数（行列数、生成数量）自动生成随机矩阵并写入存储。

## 3. 接口说明

### 3.1 控制接口
| 信号名 | 方向 | 描述 |
| :--- | :--- | :--- |
| `clk` | Input | 系统时钟 (100MHz) |
| `rst_n` | Input | 异步复位 (低电平有效) |
| `mode_is_input` | Input | 模式选择：矩阵输入模式 |
| `mode_is_gen` | Input | 模式选择：矩阵生成模式 |
| `mode_is_settings` | Input | 模式选择：系统设置模式 |
| `start` | Input | 启动脉冲，通常在数据发送完毕后由用户触发 |
| `busy` | Output | 系统忙信号 (解析中或处理中) |
| `done` | Output | 操作完成脉冲 |
| `error` | Output | 错误标志 (保持高电平直到复位或新操作) |

### 3.2 数据接口
| 信号名 | 方向 | 描述 |
| :--- | :--- | :--- |
| `uart_rx_data` | Input | UART 接收的 8-bit 数据 |
| `uart_rx_valid` | Input | UART 数据有效信号 |
| `settings_...` | Output | 输出当前的系统设置值 (MaxRow, MaxCol, Min, Max, Countdown) |

### 3.3 存储接口
| 信号名 | 方向 | 描述 |
| :--- | :--- | :--- |
| `write_request` | Output | 请求写入矩阵存储管理器 |
| `write_ready` | Input | 存储管理器准备好接收请求 |
| `data_in` | Output | 写入的数据流 |
| `data_valid` | Output | 数据流有效信号 |
| `storage_rd_addr` | Output | 读取存储元数据地址 (用于寻找空闲槽位) |
| `storage_rd_data` | Input | 存储元数据返回 |

## 4. 操作模式与数据协议

### 4.1 设置模式 (Settings Mode)
在此模式下，系统解析缓冲区中的数据以更新全局配置。

*   **输入格式**: `CMD DATA` (空格分隔的两个整数)
*   **注意**: 每次 `start` 脉冲仅处理**一条**指令（即缓冲区的前两个数字）。若要设置多个参数，需分多次发送（建议每次发送前切换模式以清空缓冲区）。
*   **指令列表 (CMD)**:
    *   `1`: 设置最大行数 (`MaxRow`)。范围: 1-32。
    *   `2`: 设置最大列数 (`MaxCol`)。范围: 1-32。
    *   `3`: 设置数据最小值 (`DataMin`)。范围: 32-bit 有符号整数。
    *   `4`: 设置数据最大值 (`DataMax`)。范围: 32-bit 有符号整数。
    *   `5`: 设置倒计时时间 (`Countdown`)。范围: 5-15 秒。
*   **示例**:
    *   发送 `"1 5\n"` -> 将最大行数设为 5。
    *   发送 `"5 10\n"` -> 将倒计时设为 10 秒。

### 4.2 矩阵输入模式 (Matrix Input Mode)
在此模式下，系统将输入的数据解析为矩阵并存储。支持两种格式。

#### A. 匿名矩阵 (Anonymous Matrix)
系统自动寻找第一个空闲的存储槽位（ID 1-7）进行存储。
*   **输入格式**: `Rows Cols Data...`
*   **示例**: `"2 2 1 2 3 4\n"`
    *   创建一个 2x2 矩阵。
    *   数据为: [1, 2, 3, 4]。
*   **行为**:
    *   若数据不足 (如只发了 3 个数)，剩余位置自动补 0。
    *   若数据过多，多余数据被忽略。

#### B. 命名矩阵 (Named Matrix)
用户指定存储槽位 ID 和名称。
*   **输入格式**: `-1 ID NameWord1 NameWord2 Rows Cols Data...`
*   **标记**: 起始的 `-1` 是命名矩阵的特征标记。
*   **参数**:
    *   `ID`: 目标存储槽位 (1-7)。
    *   `NameWord1/2`: 矩阵名称，由两个 32-bit 整数表示（共 8 个 ASCII 字符）。
*   **示例**: `"-1 1 0 0 2 2 5 6 7 8\n"`
    *   存储到 ID=1。
    *   名称为空 (0, 0)。
    *   2x2 矩阵，数据 [5, 6, 7, 8]。

### 4.3 矩阵生成模式 (Matrix Gen Mode)
在此模式下，系统根据参数生成随机矩阵。

*   **输入格式**: `Rows Cols Count`
*   **参数**:
    *   `Rows/Cols`: 生成矩阵的维度。
    *   `Count`: 生成矩阵的数量 (通常为 1 或 2)。
*   **示例**: `"3 3 1\n"` -> 生成一个 3x3 的随机矩阵。

## 5. 错误处理机制

系统在检测到以下情况时会拉高 `error` 信号，并停止当前操作：

1.  **设置错误**:
    *   参数超出允许范围 (如 MaxRow > 32)。
    *   指令代码非法。
2.  **输入错误**:
    *   矩阵维度超过 `Settings` 中设定的 MaxRow/MaxCol。
    *   输入的数据值超出 `Settings` 中设定的 Min/Max 范围。
    *   指定的 ID 非法或无空闲槽位。
3.  **生成错误**:
    *   请求生成的维度超限。
    *   请求生成的数量过多。

**恢复方法**: 错误状态通常需要通过系统复位或重新进入模式来清除。

## 6. 使用指引 (Usage Guidelines)

为了确保数据正确处理，建议遵循以下操作序列：

1.  **切换模式**: 将拨码开关拨至目标模式（如 Settings）。此操作会触发缓冲区清空。
2.  **发送数据**: 通过 UART 发送符合协议的 ASCII 字符串（以换行符结束）。
3.  **等待解析**: 等待 `busy` 信号变低，表示数据已解析入缓冲区。
4.  **确认执行**: 按下确认键（触发 `start` 脉冲）。
5.  **检查状态**:
    *   若 `done` 变高：操作成功。
    *   若 `error` 变高：操作失败，请检查输入数据或设置限制。
6.  **重复**: 若需进行下一次操作，建议先切换模式或复位，以确保状态复位。
