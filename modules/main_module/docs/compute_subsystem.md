# Compute Subsystem (计算子系统)

## 1. 概述

`compute_subsystem` 是负责执行所有矩阵运算的核心子系统。它集成了用户交互选择 (`matrix_op_selector`) 和运算执行 (`matrix_op_executor`) 两个关键环节。该子系统通过 UART 与用户交互以确定操作数，然后调度执行单元完成计算并将结果写回存储。

## 2. 功能模块

该子系统集成了以下核心模块：

1.  **`matrix_op_selector` (运算选择器)**:
    *   负责与用户进行交互 (通过 UART)。
    *   引导用户输入矩阵维度、选择源矩阵 (A, B) 和标量。
    *   扫描 BRAM 以列出可用的矩阵。
    *   验证用户选择的合法性 (如维度匹配)。
    *   拥有独立的输入解析器 (`ascii_num_sep_top` 实例) 用于处理交互指令。

2.  **`matrix_op_executor` (运算执行器)**:
    *   接收来自选择器的有效指令 (`op_type`, `matrix_a`, `matrix_b`, `scalar`)。
    *   调度具体的运算子模块 (加法、乘法、转置、卷积等)。
    *   读取源矩阵数据，计算结果，并将结果写回中央存储。

## 3. 接口说明

### 3.1 控制接口
*   `clk`, `rst_n`: 系统时钟和复位。
*   `start`: 启动选择流程的信号。
*   `confirm_btn`: 用户确认按钮，用于推进选择步骤。
*   `op_mode_in`, `calc_type_in`: 当前的运算模式配置 (来自拨码开关)。

### 3.2 UART 接口
*   `uart_rx_...`: 接收用户指令。
*   `uart_tx_...`: 发送提示信息和矩阵预览。

### 3.3 存储接口
*   **读接口**: `bram_rd_addr`, `bram_rd_data`。用于扫描矩阵列表、预览矩阵内容以及读取运算操作数。
*   **写接口**: `write_request` 及相关信号。用于将运算结果写回存储。

## 4. 内部协调逻辑

子系统内部通过状态机协调选择器和执行器的工作：

1.  **选择阶段 (`SELECTING`)**:
    *   `matrix_op_selector` 处于活动状态。
    *   它控制 BRAM 读地址以扫描和预览矩阵。
    *   它控制 UART TX 发送提示。
    *   当用户完成所有选择并通过验证后，输出 `result_valid`。

2.  **执行阶段 (`EXECUTING`)**:
    *   一旦 `result_valid` 拉高，状态机切换到执行阶段。
    *   `matrix_op_executor` 启动。
    *   执行器接管 BRAM 读地址控制权 (读取操作数)。
    *   执行器控制写接口 (写入结果)。
    *   当执行完成 (`executor_done`)，子系统返回完成状态。

## 5. 资源复用

*   **BRAM 读端口**: 在选择阶段由选择器使用，在执行阶段由执行器使用。子系统内部实现了地址多路复用。
*   **UART TX**: 仅由选择器使用 (执行器不直接输出 UART)。
