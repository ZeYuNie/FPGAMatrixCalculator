<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self' http://127.0.0.1:11459" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>设置配置 - FPGA 矩阵计算器</title>
    <link rel="stylesheet" href="../styles.css" />
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <h1><img src="../resources/svg/setting.svg" alt="" style="width: 28px; height: 28px; vertical-align: middle; margin-right: 10px; opacity: 0.9;"> 设置配置</h1>
            <button class="back-button" id="back-button">返回主页</button>
        </div>

        <div class="page-content">
            <!-- 后端连接警告卡片 -->
            <div id="backend-warning" class="warning-card" style="display: none;">
                <div style="display: flex; align-items: start; gap: 15px;">
                    <div style="font-size: 24px; color: #f57c00;">⚠️</div>
                    <div style="flex: 1;">
                        <h3 style="color: #e65100; margin: 0 0 10px 0;">Python后端连接失败</h3>
                        <p id="backend-error-message" style="color: #f57c00; margin: 0 0 10px 0;">无法连接到后端服务</p>
                        <button id="restart-backend-btn" class="warning-button">重启后端</button>
                    </div>
                </div>
            </div>
            
            <h2 style="color: #2e7d32; margin-bottom: 20px;">系统参数与配置</h2>
            <p style="color: #66bb6a; margin-bottom: 30px;">配置FPGA连接和应用参数</p>
            
            <div style="display: grid; gap: 30px;">
                <!-- FPGA 连接设置 -->
                <div>
                    <h3 style="color: #2e7d32; margin-bottom: 15px; border-bottom: 2px solid #c8e6c9; padding-bottom: 10px;">FPGA 连接</h3>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #2e7d32; font-weight: 500;">串口端口</label>
                            <input type="text" placeholder="COM3 或 /dev/ttyUSB0" style="padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px; width: 100%; max-width: 400px;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #2e7d32; font-weight: 500;">波特率</label>
                            <select style="padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px; width: 100%; max-width: 400px; font-size: 1rem;">
                                <option>9600</option>
                                <option selected>115200</option>
                                <option>230400</option>
                                <option>460800</option>
                                <option>921600</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500;">测试连接</button>
                            <span style="color: #66bb6a; font-size: 0.9rem;">● 未连接</span>
                        </div>
                    </div>
                </div>
                
                <!-- 计算设置 -->
                <div>
                    <h3 style="color: #2e7d32; margin-bottom: 15px; border-bottom: 2px solid #c8e6c9; padding-bottom: 10px;">计算设置</h3>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #2e7d32; font-weight: 500;">精度模式</label>
                            <select style="padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px; width: 100%; max-width: 400px; font-size: 1rem;">
                                <option>整数 (INT16)</option>
                                <option selected>定点数 (Q15.16)</option>
                                <option>浮点数 (FP32)</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="auto-validate" style="width: 18px; height: 18px; cursor: pointer;" />
                            <label for="auto-validate" style="color: #2e7d32; cursor: pointer;">自动验证计算结果</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="show-progress" checked style="width: 18px; height: 18px; cursor: pointer;" />
                            <label for="show-progress" style="color: #2e7d32; cursor: pointer;">显示运算进度</label>
                        </div>
                    </div>
                </div>
                
                <!-- 界面设置 -->
                <div>
                    <h3 style="color: #2e7d32; margin-bottom: 15px; border-bottom: 2px solid #c8e6c9; padding-bottom: 10px;">界面设置</h3>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #2e7d32; font-weight: 500;">主题颜色</label>
                            <select style="padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px; width: 100%; max-width: 400px; font-size: 1rem;">
                                <option selected>绿色 (默认)</option>
                                <option>蓝色</option>
                                <option>紫色</option>
                                <option>橙色</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: #2e7d32; font-weight: 500;">矩阵显示格式</label>
                            <select style="padding: 12px; border: 2px solid #c8e6c9; border-radius: 8px; width: 100%; max-width: 400px; font-size: 1rem;">
                                <option selected>标准格式</option>
                                <option>科学计数法</option>
                                <option>十六进制</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 保存和重置 -->
                <div style="display: flex; gap: 10px; padding-top: 20px; border-top: 2px solid #c8e6c9;">
                    <button style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; border: none; padding: 14px 32px; border-radius: 10px; font-size: 1rem; cursor: pointer; font-weight: 500;">保存设置</button>
                    <button style="background: white; color: #43a047; border: 2px solid #43a047; padding: 14px 32px; border-radius: 10px; font-size: 1rem; cursor: pointer; font-weight: 500;">恢复默认</button>
                </div>
            </div>
        </div>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="backend-indicator"></span>
                <span class="status-text" id="backend-status-text">检查后端连接...</span>
            </div>
        </div>
    </div>
    <script src="../page-common.js"></script>
    <script>
        // 设置页面特定逻辑：检查后端状态并显示警告
        document.addEventListener('DOMContentLoaded', () => {
            const warningCard = document.getElementById('backend-warning');
            const errorMessage = document.getElementById('backend-error-message');
            const restartBtn = document.getElementById('restart-backend-btn');
            
            // 检查并更新警告卡片
            const updateWarningCard = async () => {
                try {
                    const result = await window.electronAPI.checkBackendHealth();
                    if (!result.connected) {
                        warningCard.style.display = 'block';
                        errorMessage.textContent = result.error || '无法连接到后端服务';
                    } else {
                        warningCard.style.display = 'none';
                    }
                } catch (error) {
                    warningCard.style.display = 'block';
                    errorMessage.textContent = error.message;
                }
            };
            
            // 重启后端按钮
            restartBtn.addEventListener('click', async () => {
                restartBtn.textContent = '重启中...';
                restartBtn.disabled = true;
                try {
                    await window.electronAPI.restartBackend();
                    setTimeout(() => {
                        updateWarningCard();
                        restartBtn.textContent = '重启后端';
                        restartBtn.disabled = false;
                    }, 3500);
                } catch (error) {
                    restartBtn.textContent = '重启后端';
                    restartBtn.disabled = false;
                }
            });
            
            // 初始检查
            setTimeout(updateWarningCard, 1000);
            
            // 定期检查（每5秒）
            setInterval(updateWarningCard, 5000);
        });
    </script>
</body>
</html>